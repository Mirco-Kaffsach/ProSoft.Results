using System.Diagnostics.CodeAnalysis;

namespace ProSoft.Results;

/// <summary>
/// Class PagedResult.
/// Implements the <see cref="System.IDisposable" />
/// </summary>
/// <typeparam name="TValue">The type of the t value.</typeparam>
/// <seealso cref="System.IDisposable" />
public class PagedResult<TValue> : IDisposable
{
   /// <summary>
   /// Gets or sets the result list.
   /// </summary>
   /// <value>The result list.</value>
   public List<TValue> ResultList { get; set; }

   /// <summary>
   /// Gets or sets the type.
   /// </summary>
   /// <value>The type.</value>
   public ResultType Type { get; set; }

   /// <summary>
   /// Gets or sets the messages.
   /// </summary>
   /// <value>The messages.</value>
   public HashSet<MessageItem> Messages { get; set; } = [];

   /// <summary>
   /// Gets the size of the page.
   /// </summary>
   /// <value>The size of the page.</value>
   public int PageSize { get; private set; }

   /// <summary>
   /// Gets the page count.
   /// </summary>
   /// <value>The page count.</value>
   public int PageCount { get; private set; }

   /// <summary>
   /// Gets the current page.
   /// </summary>
   /// <value>The current page.</value>
   public int CurrentPage { get; private set; }

   /// <summary>
   /// Gets the total count.
   /// </summary>
   /// <value>The total count.</value>
   public long TotalCount { get; private set; }

   /// <summary>
   /// Initializes a new instance of the <see cref="PagedResult{TValue}"/> class.
   /// </summary>
   public PagedResult()
   {
      ResultList = [];
      PageSize = 10;
      PageCount = 1;
      CurrentPage = 1;
      TotalCount = 0;
   }

   /// <summary>
   /// Initializes a new instance of the <see cref="PagedResult{TValue}"/> class.
   /// </summary>
   /// <param name="resultList">The result list.</param>
   /// <param name="pageSize">Size of the page.</param>
   /// <param name="currentPage">The current page.</param>
   public PagedResult(IQueryable<TValue> resultList, int pageSize, int currentPage)
   {
      PageSize = pageSize;
      TotalCount = resultList.LongCount();

      double totalPages = TotalCount / (double)pageSize;
      if (totalPages % 1 != 0)
      {
         totalPages = Math.Ceiling(totalPages);
      }

      PageCount = (int)totalPages;

      if (currentPage <= 0)
         currentPage = 1;

      if (currentPage > PageCount)
         currentPage = PageCount;

      CurrentPage = currentPage;
      ResultList = resultList.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
   }

   /// <summary>
   /// Initializes a new instance of the <see cref="PagedResult{TValue}"/> class.
   /// </summary>
   /// <param name="resultList">The result list.</param>
   /// <param name="pageSize">Size of the page.</param>
   /// <param name="currentPage">The current page.</param>
   /// <param name="resultType">Type of the result.</param>
   public PagedResult(IQueryable<TValue> resultList, int pageSize, int currentPage, ResultType resultType)
      : this(resultList, pageSize, currentPage)
   {
      Type = resultType;
   }


   /// <summary>
   /// Initializes a new instance of the <see cref="PagedResult{TValue}"/> class.
   /// </summary>
   /// <param name="resultList">The result list.</param>
   /// <param name="pageSize">Size of the page.</param>
   /// <param name="currentPage">The current page.</param>
   /// <param name="resultType">Type of the result.</param>
   /// <param name="messages">The messages.</param>
   public PagedResult(IQueryable<TValue> resultList, int pageSize, int currentPage, ResultType resultType, HashSet<MessageItem> messages) 
      : this(resultList, pageSize, currentPage)
   {
      Type = resultType;
      Messages = messages;
   }

   #region IDisposable Interface Implementation

   private bool _disposed;

   /// <summary>
   /// Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged resources.
   /// </summary>
   /// <autogeneratedoc />
   [ExcludeFromCodeCoverage]
   public void Dispose()
   {
      this.Dispose(true);
      GC.SuppressFinalize(this);
   }

   /// <summary>
   /// Releases unmanaged and - optionally - managed resources.
   /// </summary>
   /// <param name="disposing"><c>true</c> to release both managed and unmanaged resources; <c>false</c> to release only unmanaged resources.</param>
   [ExcludeFromCodeCoverage]
   protected virtual void Dispose(bool disposing)
   {
      if (!_disposed && disposing)
      {
         // Disposing Logic
      }

      _disposed = true;
   }

   /// <summary>
   /// Finalizes an instance of the <see cref="PagedResult{TValue}"/> class.
   /// </summary>
   [ExcludeFromCodeCoverage]
   ~PagedResult()
   {
      this.Dispose(false);
   }

   #endregion
}
